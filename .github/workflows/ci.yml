name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    types: [closed]
    branches:
      - main
      - dev

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Lint with Ruff
        run: |
          ruff check .
          
      - name: Test with pytest
        env:
          POSTGRES_SERVER: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app_test
          REDIS_HOST: localhost
        run: |
          pytest

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Test SSH connection
        env:
          SERVER_HOST: ${{ secrets.DEV_SSH_HOST }}
          SERVER_USER: ${{ secrets.DEV_SSH_USER }}
        run: |
          ssh -v -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "echo 'SSH connection successful'"
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.DEV_SSH_HOST }}
          SERVER_USER: ${{ secrets.DEV_SSH_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} bash -s "$SERVER_PATH" << 'EOF'
            set -e
            SERVER_PATH="$1"
            unset DOCKER_HOST
            export DOCKER_HOST=unix:///var/run/docker.sock
            cd "$SERVER_PATH"
            
            COMPOSE_CMD="docker-compose"
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            fi
            
            echo "Остановка старых контейнеров..."
            $COMPOSE_CMD down || true
            
            echo "Обновление кода..."
            git fetch origin
            git reset --hard origin/dev
            git clean -fd
            
            echo "Создание сети если не существует..."
            docker network create polystirolhub-network || true
            
            echo "Сборка и запуск контейнеров..."
            $COMPOSE_CMD build --no-cache backend
            $COMPOSE_CMD up -d
            
            echo "Очистка старых образов..."
            docker image prune -f
            
            echo "Деплой завершен!"
          EOF

  deploy-main:
    runs-on: ubuntu-latest
    needs: test
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Test SSH connection
        env:
          SERVER_HOST: ${{ secrets.MAIN_SSH_HOST }}
          SERVER_USER: ${{ secrets.MAIN_SSH_USER }}
        run: |
          ssh -v -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "echo 'SSH connection successful'"
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.MAIN_SSH_HOST }}
          SERVER_USER: ${{ secrets.MAIN_SSH_USER }}
          SERVER_PATH: ${{ secrets.PROD_SERVER_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} bash -s "$SERVER_PATH" << 'EOF'
            set -e
            SERVER_PATH="$1"
            unset DOCKER_HOST
            export DOCKER_HOST=unix:///var/run/docker.sock
            cd "$SERVER_PATH"
            
            COMPOSE_CMD="docker-compose"
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            fi
            
            echo "Остановка старых контейнеров..."
            $COMPOSE_CMD down || true
            
            echo "Обновление кода..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            echo "Создание сети если не существует..."
            docker network create polystirolhub-network || true
            
            echo "Сборка и запуск контейнеров..."
            $COMPOSE_CMD build --no-cache backend
            $COMPOSE_CMD up -d
            
            echo "Очистка старых образов..."
            docker image prune -f
            
            echo "Деплой завершен!"
          EOF
